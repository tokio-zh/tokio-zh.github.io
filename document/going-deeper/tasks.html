<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>任务 | Tokio中文</title>
    <meta name="description" content="Tokio：Rust编程语言的异步运行时,提供异步事件驱动平台，构建快速，可靠和轻量级网络应用。利用Rust的所有权和并发模型确保线程安全">
    <link rel="icon" href="/favicon.ico">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#3eaf7c">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="apple-touch-icon" href="/icons/apple-touch-icon-152x152.png">
  <meta name="msapplication-TileImage" content="/icons/msapplication-icon-144x144.png">
  <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/assets/css/styles.8bade797.css" as="style"><link rel="preload" href="/assets/js/app.8bade797.js" as="script"><link rel="preload" href="/assets/js/35.95be69d9.js" as="script"><link rel="prefetch" href="/assets/css/1.styles.729a41a7.css"><link rel="prefetch" href="/assets/css/2.styles.6f2df653.css"><link rel="prefetch" href="/assets/js/1.729a41a7.js"><link rel="prefetch" href="/assets/js/10.f4dee4dc.js"><link rel="prefetch" href="/assets/js/11.0a79d276.js"><link rel="prefetch" href="/assets/js/12.9a1ecca2.js"><link rel="prefetch" href="/assets/js/13.f323aedb.js"><link rel="prefetch" href="/assets/js/14.f94ed1c8.js"><link rel="prefetch" href="/assets/js/15.2e17eed0.js"><link rel="prefetch" href="/assets/js/16.5f7f0fb0.js"><link rel="prefetch" href="/assets/js/17.a804f778.js"><link rel="prefetch" href="/assets/js/18.917a7b15.js"><link rel="prefetch" href="/assets/js/19.515a2278.js"><link rel="prefetch" href="/assets/js/2.6f2df653.js"><link rel="prefetch" href="/assets/js/20.773272da.js"><link rel="prefetch" href="/assets/js/21.40aff844.js"><link rel="prefetch" href="/assets/js/22.0786618d.js"><link rel="prefetch" href="/assets/js/23.c63536e4.js"><link rel="prefetch" href="/assets/js/24.9c06a2f7.js"><link rel="prefetch" href="/assets/js/25.4a194b57.js"><link rel="prefetch" href="/assets/js/26.40c11936.js"><link rel="prefetch" href="/assets/js/27.9e35a1f5.js"><link rel="prefetch" href="/assets/js/28.f007bc19.js"><link rel="prefetch" href="/assets/js/29.b2b6291e.js"><link rel="prefetch" href="/assets/js/3.6ae31a5f.js"><link rel="prefetch" href="/assets/js/30.f37829da.js"><link rel="prefetch" href="/assets/js/31.a71b9216.js"><link rel="prefetch" href="/assets/js/32.33337511.js"><link rel="prefetch" href="/assets/js/33.2eb4488f.js"><link rel="prefetch" href="/assets/js/34.967d43ee.js"><link rel="prefetch" href="/assets/js/36.9c0eb4ef.js"><link rel="prefetch" href="/assets/js/37.8fba8c6a.js"><link rel="prefetch" href="/assets/js/38.6f18dc3e.js"><link rel="prefetch" href="/assets/js/39.1064e57f.js"><link rel="prefetch" href="/assets/js/4.4178ba81.js"><link rel="prefetch" href="/assets/js/40.0122edd7.js"><link rel="prefetch" href="/assets/js/41.c85cb408.js"><link rel="prefetch" href="/assets/js/42.f08452f5.js"><link rel="prefetch" href="/assets/js/43.923b63dc.js"><link rel="prefetch" href="/assets/js/44.fe42b200.js"><link rel="prefetch" href="/assets/js/45.fbe2b9fb.js"><link rel="prefetch" href="/assets/js/5.9ab7d2a6.js"><link rel="prefetch" href="/assets/js/6.e89b2efe.js"><link rel="prefetch" href="/assets/js/7.2ef1920d.js"><link rel="prefetch" href="/assets/js/8.60746b2b.js"><link rel="prefetch" href="/assets/js/9.740f1fa8.js">
    <link rel="stylesheet" href="/assets/css/styles.8bade797.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Tokio中文</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/document/" class="nav-link router-link-active">文档</a></div><div class="nav-item"><a href="/community/" class="nav-link">社区</a></div><div class="nav-item"><a href="/blog/" class="nav-link">博客</a></div><div class="nav-item"><a href="https://rustlang-cn.org/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Rust中文
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://tokio.rs" target="_blank" rel="noopener noreferrer" class="nav-link external">
  英文
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/tokio-zh/tokio-zh" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/document/" class="nav-link router-link-active">文档</a></div><div class="nav-item"><a href="/community/" class="nav-link">社区</a></div><div class="nav-item"><a href="/blog/" class="nav-link">博客</a></div><div class="nav-item"><a href="https://rustlang-cn.org/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Rust中文
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://tokio.rs" target="_blank" rel="noopener noreferrer" class="nav-link external">
  英文
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/tokio-zh/tokio-zh" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav> <div class="carbon-ads"></div> <ul class="sidebar-links"><li><a href="/document/" class="sidebar-link">何为Tokio</a></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>开始</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/document/getting-started/hello-world.html" class="sidebar-link">Hello World</a></li><li><a href="/document/getting-started/futures.html" class="sidebar-link">Futures</a></li><li><a href="/document/getting-started/runtime.html" class="sidebar-link">运行时</a></li><li><a href="/document/getting-started/echo.html" class="sidebar-link">示例：Echo服务器</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>Tokio与I/O</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/document/io/overview.html" class="sidebar-link">I/O概叙</a></li><li><a href="/document/io/reading_writing_data.html" class="sidebar-link">读写数据</a></li><li><a href="/document/io/poll.html" class="sidebar-link">Poll（轮询）APIs</a></li><li><a href="/document/io/async_read_write.html" class="sidebar-link">直接使用AsyncRead和AsyncWrite</a></li><li><a href="/document/io/filesystem.html" class="sidebar-link">文件系统APIs</a></li><li><a href="/document/io/datagrams.html" class="sidebar-link">Datagram APIs</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>Futures-Streams-Sinks</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/document/futures-streams-sinks/overview.html" class="sidebar-link">概叙</a></li><li><a href="/document/futures-streams-sinks/futures.html" class="sidebar-link">使用Future</a></li><li><a href="/document/futures-streams-sinks/streams.html" class="sidebar-link">使用Stream</a></li><li><a href="/document/futures-streams-sinks/sink.html" class="sidebar-link">使用Sink</a></li><li><a href="/document/futures-streams-sinks/putting-it-together.html" class="sidebar-link">结合在一起</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading open"><span>深入</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/document/going-deeper/futures.html" class="sidebar-link">Futures</a></li><li><a href="/document/going-deeper/tasks.html" class="active sidebar-link">任务</a></li><li><a href="/document/going-deeper/runtime-model.html" class="sidebar-link">运行时模型</a></li><li><a href="/document/going-deeper/io.html" class="sidebar-link">Tokio与I/O</a></li><li><a href="/document/going-deeper/chat.html" class="sidebar-link">示例：聊天服务器</a></li><li><a href="/document/going-deeper/timers.html" class="sidebar-link">Timers</a></li><li><a href="/document/going-deeper/futures-mechanics.html" class="sidebar-link">基础组合器</a></li><li><a href="/document/going-deeper/returning.html" class="sidebar-link">返回Futures</a></li><li><a href="/document/going-deeper/frames.html" class="sidebar-link">使用构建流</a></li><li><a href="/document/going-deeper/building-runtime.html" class="sidebar-link">构建一个运行时</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>内部原理</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/document/internals/intro.html" class="sidebar-link">介绍</a></li><li><a href="/document/internals/runtime-model.html" class="sidebar-link">运行时模型</a></li><li><a href="/document/internals/net.html" class="sidebar-link">非阻塞I/O</a></li></ul></div></li><li><a href="/document/api.html" class="sidebar-link">API文档</a></li></ul> </div> <div class="page"> <div class="content"><h1 id="任务"><a href="#任务" aria-hidden="true" class="header-anchor">#</a> 任务</h1> <p>任务是应用程序的“逻辑单元”。 它们类似于Go的goroutine和Erlang的进程，但是异步。 换句话说，任务是异步绿色线程。</p> <p>鉴于任务运行异步逻辑位，它们由Future特征表示。 任务完成处理后，任务的<code>future</code>实现将以（）值完成。</p> <p>任务被传递给执行程序，执行程序处理任务的调度。 执行程序通常在一组或一组线程中调度许多任务。 <strong>任务不得执行计算繁重的逻辑，否则将阻止其他任务执行</strong> 。 因此，不要尝试将斐波那契序列计算为任务。</p> <p>任务通过直接实施Future特征或通过使用<code>future</code>和tokio crate中可用的各种组合函数构建<code>future</code>来实现。</p> <p>下面是一个使用HTTP get从URI获取值并缓存结果的示例。</p> <ol><li>检查缓存以查看是否存在URI条目。</li> <li>如果没有条目，请执行HTTP get。</li> <li>将响应存储在缓存中。</li> <li>返回response。</li></ol> <p>整个事件序列也包含超时，以防止无限制的执行时间。</p> <div class="language-rust extra-class"><pre class="language-rust"><code>
<span class="token comment">// The functions here all return `Box&lt;Future&lt;...&gt;&gt;`. This is one</span>
<span class="token comment">// of a number of ways to return futures. For more details on</span>
<span class="token comment">// returning futures, see the &quot;Returning futures&quot; section in</span>
<span class="token comment">// &quot;Going deeper: Futures&quot;.</span>

<span class="token comment">/// Get a URI from some remote cache.</span>
<span class="token keyword">fn</span> <span class="token function">cache_get</span><span class="token punctuation">(</span>uri<span class="token punctuation">:</span> <span class="token operator">&amp;</span>str<span class="token punctuation">)</span>
    <span class="token punctuation">-&gt;</span> Box<span class="token operator">&lt;</span>Future<span class="token operator">&lt;</span>Item <span class="token operator">=</span> Option<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token punctuation">,</span> Error <span class="token operator">=</span> Error<span class="token operator">&gt;&gt;</span>
<span class="token punctuation">{</span> <span class="token punctuation">...</span> <span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function">cache_put</span><span class="token punctuation">(</span>uri<span class="token punctuation">:</span> <span class="token operator">&amp;</span>str<span class="token punctuation">,</span> val<span class="token punctuation">:</span> String<span class="token punctuation">)</span>
    <span class="token punctuation">-&gt;</span> Box<span class="token operator">&lt;</span>Future<span class="token operator">&lt;</span>Item <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Error <span class="token operator">=</span> Error<span class="token operator">&gt;&gt;</span>
<span class="token punctuation">{</span> <span class="token punctuation">...</span> <span class="token punctuation">}</span>

<span class="token comment">/// Do a full HTTP get to a remote URL</span>
<span class="token keyword">fn</span> <span class="token function">http_get</span><span class="token punctuation">(</span>uri<span class="token punctuation">:</span> <span class="token operator">&amp;</span>str<span class="token punctuation">)</span>
    <span class="token punctuation">-&gt;</span> Box<span class="token operator">&lt;</span>Future<span class="token operator">&lt;</span>Item <span class="token operator">=</span> String<span class="token punctuation">,</span> Error <span class="token operator">=</span> Error<span class="token operator">&gt;&gt;</span>
<span class="token punctuation">{</span> <span class="token punctuation">...</span> <span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function">fetch_and_cache</span><span class="token punctuation">(</span>url<span class="token punctuation">:</span> <span class="token operator">&amp;</span>str<span class="token punctuation">)</span>
    <span class="token punctuation">-&gt;</span> Box<span class="token operator">&lt;</span>Future<span class="token operator">&lt;</span>Item <span class="token operator">=</span> String<span class="token punctuation">,</span> Error <span class="token operator">=</span> Error<span class="token operator">&gt;&gt;</span>
<span class="token punctuation">{</span>
    <span class="token comment">// The URL has to be converted to a string so that it can be</span>
    <span class="token comment">// moved into the closure. Given futures are asynchronous,</span>
    <span class="token comment">// the stack is not around anymore by the time the closure is called.</span>
    <span class="token keyword">let</span> url <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> response <span class="token operator">=</span> <span class="token function">http_get</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>url<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">and_then</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token punctuation">|</span>response<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
            <span class="token function">cache_put</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>url<span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token operator">|</span>_<span class="token operator">|</span> response<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    Box<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> url <span class="token operator">=</span> <span class="token string">&quot;https://example.com&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> response <span class="token operator">=</span> <span class="token function">cache_get</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">and_then</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>resp<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
      <span class="token comment">// `Either` is a utility provided by the `futures` crate</span>
      <span class="token comment">// that enables returning different futures from a single</span>
      <span class="token comment">// closure without boxing.</span>
      <span class="token keyword">match</span> resp <span class="token punctuation">{</span>
          <span class="token function">Some</span><span class="token punctuation">(</span>resp<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Either<span class="token punctuation">::</span><span class="token function">A</span><span class="token punctuation">(</span>future<span class="token punctuation">::</span><span class="token function">ok</span><span class="token punctuation">(</span>resp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          None <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
              Either<span class="token punctuation">::</span><span class="token function">B</span><span class="token punctuation">(</span><span class="token function">fetch_and_cache</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Only let the task run for up to 20 seconds.</span>
<span class="token comment">//</span>
<span class="token comment">// This uses a fictional timer API. Use the `tokio-timer` crate for</span>
<span class="token comment">// all your actual timer needs.</span>
<span class="token keyword">let</span> task <span class="token operator">=</span> Timeout<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> Duration<span class="token punctuation">::</span><span class="token function">from_secs</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

my_executor<span class="token punctuation">.</span><span class="token function">spawn</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>由于这些步骤对于完成任务都是必需的，因此将它们全部分组到同一任务中是有意义的。</p> <p>但是，如果不是在缓存未命中时更新缓存，而是希望在一个时间间隔内更新缓存值，那么将其拆分为多个任务是有意义的，因为这些步骤不再直接相关。</p> <div class="language-rust extra-class"><pre class="language-rust"><code>
<span class="token keyword">let</span> url <span class="token operator">=</span> <span class="token string">&quot;https://example.com&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// An Interval is a stream that yields `()` on a fixed interval.</span>
<span class="token keyword">let</span> update_cache <span class="token operator">=</span> Interval<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>Duration<span class="token punctuation">::</span><span class="token function">from_secs</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// On each tick of the interval, update the cache. This is done</span>
    <span class="token comment">// by using the same function from the previous snippet.</span>
    <span class="token punctuation">.</span><span class="token function">for_each</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>_<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token function">fetch_and_cache</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token operator">|</span>resp<span class="token operator">|</span> <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;updated cache with {}&quot;</span><span class="token punctuation">,</span> resp<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Spawn the cache update task so that it runs in the background</span>
my_executor<span class="token punctuation">.</span><span class="token function">spawn</span><span class="token punctuation">(</span>update_cache<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Now, only get from the cache.</span>
<span class="token comment">// (NB: see next section about ensuring the cache is up to date.)</span>
<span class="token keyword">let</span> response <span class="token operator">=</span> <span class="token function">cache_get</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> task <span class="token operator">=</span> Timeout<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> Duration<span class="token punctuation">::</span><span class="token function">from_secs</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

my_executor<span class="token punctuation">.</span><span class="token function">spawn</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="消息传递"><a href="#消息传递" aria-hidden="true" class="header-anchor">#</a> 消息传递</h2> <p>就像Go和Erlang一样，任务可以使用消息传递进行通信。 实际上，使用消息传递来协调多个任务是很常见的。 这允许独立任务仍然相互作用。</p> <p><code>future</code>包提供了一个同步模块，其中包含一些适合跨任务传递消息的通道类型。</p> <ul><li>oneshot是一个用于发送一个值的通道。</li> <li>mpsc是用于发送许多（零个或多个）值的通道。</li></ul> <p>前面的例子并不完全正确。 鉴于任务同时执行，无法保证缓存更新任务在其他任务尝试从缓存中读取时将第一个值写入缓存。</p> <p>这是使用消息传递的完美情况。 高速缓存更新任务可以发送消息，通知其他任务它已使用初始值启动了高速缓存。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> url <span class="token operator">=</span> <span class="token string">&quot;https://example.com&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> <span class="token punctuation">(</span>primed_tx<span class="token punctuation">,</span> primed_rx<span class="token punctuation">)</span> <span class="token operator">=</span> oneshot<span class="token punctuation">::</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> update_cache <span class="token operator">=</span> <span class="token function">fetch_and_cache</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
    <span class="token comment">// Now, notify the other task that the cache is primed</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token operator">|</span>_<span class="token operator">|</span> primed_tx<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// Then we can start refreshing the cache on an interval</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>_<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
        Interval<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>Duration<span class="token punctuation">::</span><span class="token function">from_secs</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">for_each</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>_<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
                <span class="token function">fetch_and_cache</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token operator">|</span>resp<span class="token operator">|</span> <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">&quot;updated cache with {}&quot;</span><span class="token punctuation">,</span> resp<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Spawn the cache update task so that it runs in the background</span>
my_executor<span class="token punctuation">.</span><span class="token function">spawn</span><span class="token punctuation">(</span>update_cache<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// First, wait for the cache to primed</span>
<span class="token keyword">let</span> response <span class="token operator">=</span> primed_rx
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token operator">|</span>_<span class="token operator">|</span> <span class="token function">cache_get</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> task <span class="token operator">=</span> Timeout<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> Duration<span class="token punctuation">::</span><span class="token function">from_secs</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

my_executor<span class="token punctuation">.</span><span class="token function">spawn</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="任务通知"><a href="#任务通知" aria-hidden="true" class="header-anchor">#</a> 任务通知</h2> <p>使用Tokio构建的应用程序被构造为一组并发运行的任务。 这是服务器的基本结构：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> server <span class="token operator">=</span> listener<span class="token punctuation">.</span><span class="token function">incoming</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">for_each</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>socket<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
    <span class="token comment">// Spawn a task to process the connection</span>
    tokio<span class="token punctuation">::</span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token function">process</span><span class="token punctuation">(</span>socket<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">map_err</span><span class="token punctuation">(</span><span class="token operator">|</span>_<span class="token operator">|</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Just drop the error</span>

tokio<span class="token punctuation">::</span><span class="token function">run</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>在这种情况下，我们为每个入站服务器套接字生成一个任务。 但是，也可以实现处理同一套接字上所有入站连接的服务器future：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">pub</span> <span class="token keyword">struct</span> Server <span class="token punctuation">{</span>
    listener<span class="token punctuation">:</span> TcpListener<span class="token punctuation">,</span>
    connections<span class="token punctuation">:</span> Vec<span class="token operator">&lt;</span>Box<span class="token operator">&lt;</span>Future<span class="token operator">&lt;</span>Item <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Error <span class="token operator">=</span> io<span class="token punctuation">::</span>Error<span class="token operator">&gt;</span> <span class="token operator">+</span> Send<span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> Future <span class="token keyword">for</span> Server <span class="token punctuation">{</span>
    <span class="token keyword">type</span> Item <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">type</span> Error <span class="token operator">=</span> io<span class="token punctuation">::</span>Error<span class="token punctuation">;</span>

    <span class="token keyword">fn</span> <span class="token function">poll</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> Result<span class="token operator">&lt;</span>Async<span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> io<span class="token punctuation">::</span>Error<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// First, accept all new connections</span>
        <span class="token keyword">loop</span> <span class="token punctuation">{</span>
            <span class="token keyword">match</span> <span class="token keyword">self</span><span class="token punctuation">.</span>listener<span class="token punctuation">.</span><span class="token function">poll_accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span> <span class="token punctuation">{</span>
                Async<span class="token punctuation">::</span><span class="token function">Ready</span><span class="token punctuation">(</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span> _<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    <span class="token keyword">let</span> connection <span class="token operator">=</span> <span class="token function">process</span><span class="token punctuation">(</span>socket<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">self</span><span class="token punctuation">.</span>connections<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>connection<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                Async<span class="token punctuation">::</span>NotReady <span class="token operator">=&gt;</span> <span class="token keyword">break</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Now, poll all connection futures.</span>
        <span class="token keyword">let</span> len <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>connections<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">..</span>len<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rev</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">match</span> <span class="token keyword">self</span><span class="token punctuation">.</span>connections<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span> <span class="token punctuation">{</span>
                Async<span class="token punctuation">::</span><span class="token function">Ready</span><span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    <span class="token keyword">self</span><span class="token punctuation">.</span>connections<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                Async<span class="token punctuation">::</span>NotReady <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// `NotReady` is returned here because the future never actually</span>
        <span class="token comment">// completes. The server runs until it is dropped.</span>
        <span class="token function">Ok</span><span class="token punctuation">(</span>Async<span class="token punctuation">::</span>NotReady<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这两种策略在功能上是等效的，但具有明显不同的运行时特性。</p> <p>通知发生在任务级别。 该任务不知道哪个子<code>future</code>触发了通知。 因此，无论何时轮询任务，都必须尝试轮询所有子<code>future</code>。</p> <p><img src="https://rustlang-cn.github.io/assets/img/task-layout.14e684d0.png" alt="task"></p> <p>在此任务中，有三个子<code>future</code>可以进行轮询。 如果其中一个子<code>future</code>所包含的资源转为“就绪”，则任务本身会收到通知，并会尝试轮询其所有三个子<code>future</code>。 其中一个将推进，这反过来推进任务的内部状态。</p> <p>关键是尽量减少任务，尽可能少地完成每项任务。 这就是为什么服务器为每个连接生成新任务而不是在与侦听器相同的任务中处理连接的原因。</p> <p>好吧，实际上有一种方法可以让任务知道哪个子<code>future</code>使用FuturesUnordered触发了通知，但通常正确的做法是生成一个新任务。</p></div> <div class="page-edit"><div class="edit-link"><a href="https://github.com/tokio-zh/tokio-zh/edit/master/docs/document/going-deeper/tasks.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">上次更新: </span> <span class="time">11/4/2018, 2:00:23 PM</span></div></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/document/going-deeper/futures.html" class="prev">
          Futures
        </a></span> <span class="next"><a href="/document/going-deeper/runtime-model.html">
          运行时模型
        </a>
        →
      </span></p></div> <div class="bsa-cpc-wrapper"><div class="bsa-cpc"></div></div></div> <!----></div></div>
    <script src="/assets/js/app.8bade797.js" defer></script><script src="/assets/js/35.95be69d9.js" defer></script>
  </body>
</html>
