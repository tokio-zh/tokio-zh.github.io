<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>非阻塞I/O | Tokio中文</title>
    <meta name="description" content="Tokio：Rust编程语言的异步运行时,提供异步事件驱动平台，构建快速，可靠和轻量级网络应用。利用Rust的所有权和并发模型确保线程安全">
    <link rel="icon" href="/favicon.ico">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#3eaf7c">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="apple-touch-icon" href="/icons/apple-touch-icon-152x152.png">
  <meta name="msapplication-TileImage" content="/icons/msapplication-icon-144x144.png">
  <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/assets/css/styles.8bade797.css" as="style"><link rel="preload" href="/assets/js/app.8bade797.js" as="script"><link rel="preload" href="/assets/js/38.6f18dc3e.js" as="script"><link rel="prefetch" href="/assets/css/1.styles.729a41a7.css"><link rel="prefetch" href="/assets/css/2.styles.6f2df653.css"><link rel="prefetch" href="/assets/js/1.729a41a7.js"><link rel="prefetch" href="/assets/js/10.f4dee4dc.js"><link rel="prefetch" href="/assets/js/11.0a79d276.js"><link rel="prefetch" href="/assets/js/12.9a1ecca2.js"><link rel="prefetch" href="/assets/js/13.f323aedb.js"><link rel="prefetch" href="/assets/js/14.f94ed1c8.js"><link rel="prefetch" href="/assets/js/15.2e17eed0.js"><link rel="prefetch" href="/assets/js/16.5f7f0fb0.js"><link rel="prefetch" href="/assets/js/17.a804f778.js"><link rel="prefetch" href="/assets/js/18.917a7b15.js"><link rel="prefetch" href="/assets/js/19.515a2278.js"><link rel="prefetch" href="/assets/js/2.6f2df653.js"><link rel="prefetch" href="/assets/js/20.773272da.js"><link rel="prefetch" href="/assets/js/21.40aff844.js"><link rel="prefetch" href="/assets/js/22.0786618d.js"><link rel="prefetch" href="/assets/js/23.c63536e4.js"><link rel="prefetch" href="/assets/js/24.9c06a2f7.js"><link rel="prefetch" href="/assets/js/25.4a194b57.js"><link rel="prefetch" href="/assets/js/26.40c11936.js"><link rel="prefetch" href="/assets/js/27.9e35a1f5.js"><link rel="prefetch" href="/assets/js/28.f007bc19.js"><link rel="prefetch" href="/assets/js/29.b2b6291e.js"><link rel="prefetch" href="/assets/js/3.6ae31a5f.js"><link rel="prefetch" href="/assets/js/30.f37829da.js"><link rel="prefetch" href="/assets/js/31.a71b9216.js"><link rel="prefetch" href="/assets/js/32.33337511.js"><link rel="prefetch" href="/assets/js/33.2eb4488f.js"><link rel="prefetch" href="/assets/js/34.967d43ee.js"><link rel="prefetch" href="/assets/js/35.95be69d9.js"><link rel="prefetch" href="/assets/js/36.9c0eb4ef.js"><link rel="prefetch" href="/assets/js/37.8fba8c6a.js"><link rel="prefetch" href="/assets/js/39.1064e57f.js"><link rel="prefetch" href="/assets/js/4.4178ba81.js"><link rel="prefetch" href="/assets/js/40.0122edd7.js"><link rel="prefetch" href="/assets/js/41.c85cb408.js"><link rel="prefetch" href="/assets/js/42.f08452f5.js"><link rel="prefetch" href="/assets/js/43.923b63dc.js"><link rel="prefetch" href="/assets/js/44.fe42b200.js"><link rel="prefetch" href="/assets/js/45.fbe2b9fb.js"><link rel="prefetch" href="/assets/js/5.9ab7d2a6.js"><link rel="prefetch" href="/assets/js/6.e89b2efe.js"><link rel="prefetch" href="/assets/js/7.2ef1920d.js"><link rel="prefetch" href="/assets/js/8.60746b2b.js"><link rel="prefetch" href="/assets/js/9.740f1fa8.js">
    <link rel="stylesheet" href="/assets/css/styles.8bade797.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Tokio中文</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/document/" class="nav-link router-link-active">文档</a></div><div class="nav-item"><a href="/community/" class="nav-link">社区</a></div><div class="nav-item"><a href="/blog/" class="nav-link">博客</a></div><div class="nav-item"><a href="https://rustlang-cn.org/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Rust中文
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://tokio.rs" target="_blank" rel="noopener noreferrer" class="nav-link external">
  英文
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/tokio-zh/tokio-zh" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/document/" class="nav-link router-link-active">文档</a></div><div class="nav-item"><a href="/community/" class="nav-link">社区</a></div><div class="nav-item"><a href="/blog/" class="nav-link">博客</a></div><div class="nav-item"><a href="https://rustlang-cn.org/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Rust中文
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://tokio.rs" target="_blank" rel="noopener noreferrer" class="nav-link external">
  英文
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/tokio-zh/tokio-zh" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav> <div class="carbon-ads"></div> <ul class="sidebar-links"><li><a href="/document/" class="sidebar-link">何为Tokio</a></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>开始</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/document/getting-started/hello-world.html" class="sidebar-link">Hello World</a></li><li><a href="/document/getting-started/futures.html" class="sidebar-link">Futures</a></li><li><a href="/document/getting-started/runtime.html" class="sidebar-link">运行时</a></li><li><a href="/document/getting-started/echo.html" class="sidebar-link">示例：Echo服务器</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>Tokio与I/O</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/document/io/overview.html" class="sidebar-link">I/O概叙</a></li><li><a href="/document/io/reading_writing_data.html" class="sidebar-link">读写数据</a></li><li><a href="/document/io/poll.html" class="sidebar-link">Poll（轮询）APIs</a></li><li><a href="/document/io/async_read_write.html" class="sidebar-link">直接使用AsyncRead和AsyncWrite</a></li><li><a href="/document/io/filesystem.html" class="sidebar-link">文件系统APIs</a></li><li><a href="/document/io/datagrams.html" class="sidebar-link">Datagram APIs</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>Futures-Streams-Sinks</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/document/futures-streams-sinks/overview.html" class="sidebar-link">概叙</a></li><li><a href="/document/futures-streams-sinks/futures.html" class="sidebar-link">使用Future</a></li><li><a href="/document/futures-streams-sinks/streams.html" class="sidebar-link">使用Stream</a></li><li><a href="/document/futures-streams-sinks/sink.html" class="sidebar-link">使用Sink</a></li><li><a href="/document/futures-streams-sinks/putting-it-together.html" class="sidebar-link">结合在一起</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>深入</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/document/going-deeper/futures.html" class="sidebar-link">Futures</a></li><li><a href="/document/going-deeper/tasks.html" class="sidebar-link">任务</a></li><li><a href="/document/going-deeper/runtime-model.html" class="sidebar-link">运行时模型</a></li><li><a href="/document/going-deeper/io.html" class="sidebar-link">Tokio与I/O</a></li><li><a href="/document/going-deeper/chat.html" class="sidebar-link">示例：聊天服务器</a></li><li><a href="/document/going-deeper/timers.html" class="sidebar-link">Timers</a></li><li><a href="/document/going-deeper/futures-mechanics.html" class="sidebar-link">基础组合器</a></li><li><a href="/document/going-deeper/returning.html" class="sidebar-link">返回Futures</a></li><li><a href="/document/going-deeper/frames.html" class="sidebar-link">使用构建流</a></li><li><a href="/document/going-deeper/building-runtime.html" class="sidebar-link">构建一个运行时</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading open"><span>内部原理</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/document/internals/intro.html" class="sidebar-link">介绍</a></li><li><a href="/document/internals/runtime-model.html" class="sidebar-link">运行时模型</a></li><li><a href="/document/internals/net.html" class="active sidebar-link">非阻塞I/O</a></li></ul></div></li><li><a href="/document/api.html" class="sidebar-link">API文档</a></li></ul> </div> <div class="page"> <div class="content"><h1 id="非阻塞i-o"><a href="#非阻塞i-o" aria-hidden="true" class="header-anchor">#</a> 非阻塞I/O</h1> <p>本节介绍Tokio提供的网络资源和<code>drivers</code>。 这个组件提供Tokio的主要功能之一：非阻塞，事件驱动，由适当的操作系统原语提供的网络（epoll，kqueue，IOCP，...）。 它以资源和<code>drivers</code>模式为模型在上一节中描述。</p> <p>网络<code>drivers</code>使用<strong>mio</strong>构建，网络资源由后备实现<a href="https://docs.rs/mio/0.6/mio/event/trait.Evented.html" target="_blank" rel="noopener noreferrer"><code>Evented</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>的类型。</p> <p>本指南将重点介绍TCP类型。 其他网络资源（UDP，unix插座，管道等）遵循相同的模式。</p> <h2 id="网络资源"><a href="#网络资源" aria-hidden="true" class="header-anchor">#</a> 网络资源</h2> <p>网络资源是由网络句柄和对为资源供电的<a href="#the-network-driver">driver</a>的引用组成的类型，例如<a href="https://docs.rs/tokio/0.1/tokio/net/struct.TcpListener.html" target="_blank" rel="noopener noreferrer"><code>TcpListener</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>和<a href="https://docs.rs/tokio/0.1/tokio/net/struct.TcpStream.html" target="_blank" rel="noopener noreferrer"><code>TcpStream</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。 最初，在首次创建资源时，driver指针可能是<code>None</code>：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> listener <span class="token operator">=</span> TcpListener<span class="token punctuation">::</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>addr<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>在这种情况下，尚未设置对driver的引用。 但是，如果使用带有<a href="https://docs.rs/tokio-reactor/0.1/tokio_reactor/struct.Handle.html" target="_blank" rel="noopener noreferrer"><code>Handle</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>引用的构造函数，则driver引用将设置为给定句柄表示的driver：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> listener <span class="token operator">=</span> TcpListener<span class="token punctuation">::</span><span class="token function">from_std</span><span class="token punctuation">(</span>std_listener<span class="token punctuation">,</span> <span class="token operator">&amp;</span>my_reactor_handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>一旦driver与资源相关联，就会将其设置为该资源的生命周期，不能改变。 相关的driver负责接收网络资源的操作系统事件并通知对该资源表示兴趣的任务。</p> <h2 id="使用资源"><a href="#使用资源" aria-hidden="true" class="header-anchor">#</a> 使用资源</h2> <p>资源类型包括以<code>poll_</code>为前缀和在返回类型中包含<code>Async</code>的非阻塞函数。 这些函数与任务系统关联，应该从任务中使用，并作为[<code>Future</code>]实现一部分使用。 例如，<a href="https://docs.rs/tokio/0.1/tokio/net/struct.TcpStream.html" target="_blank" rel="noopener noreferrer"><code>TcpStream</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>提供[<code>poll_read</code>]和[<code>poll_write</code>]。 <a href="https://docs.rs/tokio/0.1/tokio/net/struct.TcpListener.html" target="_blank" rel="noopener noreferrer"><code>TcpListener</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>提供[<code>poll_accept</code>]。</p> <p>这里有一个使用[<code>poll_accept</code>]]接受来自侦听器的入站套接字并通过生成新任务来处理它们的任务：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">struct</span> Acceptor <span class="token punctuation">{</span>
    listener<span class="token punctuation">:</span> TcpListener<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> Future <span class="token keyword">for</span> Acceptor <span class="token punctuation">{</span>
    <span class="token keyword">type</span> Item <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">type</span> Error <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">fn</span> <span class="token function">poll</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> Poll<span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token punctuation">::</span>Item<span class="token punctuation">,</span> <span class="token keyword">Self</span><span class="token punctuation">::</span>Error<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">loop</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> <span class="token punctuation">(</span>socket<span class="token punctuation">,</span> _<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">try_ready!</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>listener<span class="token punctuation">.</span><span class="token function">poll_accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// Spawn a task to process the socket</span>
            tokio<span class="token punctuation">::</span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token function">process</span><span class="token punctuation">(</span>socket<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>资源类型还可以包括返回 <code>future</code>的函数。 这些是使用<code>poll_</code>函数提供附加功能的帮助程序。 例如，<a href="https://docs.rs/tokio/0.1/tokio/net/struct.TcpStream.html" target="_blank" rel="noopener noreferrer"><code>TcpStream</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>提供了一个返回 <code>future</code>的[<code>connect</code>]函数。一旦<a href="https://docs.rs/tokio/0.1/tokio/net/struct.TcpStream.html" target="_blank" rel="noopener noreferrer"><code>TcpStream</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>与对等方建立了连接（或未能成功），这个 <code>future</code>就会完成。</p> <p>使用组合器连接<a href="https://docs.rs/tokio/0.1/tokio/net/struct.TcpStream.html" target="_blank" rel="noopener noreferrer"><code>TcpStream</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>：</p> <div class="language-rust extra-class"><pre class="language-rust"><code>tokio<span class="token punctuation">::</span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> connect_future <span class="token operator">=</span> TcpStream<span class="token punctuation">::</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>

    connect_future
        <span class="token punctuation">.</span><span class="token function">and_then</span><span class="token punctuation">(</span><span class="token operator">|</span>socket<span class="token operator">|</span> <span class="token function">process</span><span class="token punctuation">(</span>socket<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">map_err</span><span class="token punctuation">(</span><span class="token operator">|</span>_<span class="token operator">|</span> <span class="token function">panic!</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>future</code>也可以直接用于其他<code>future</code>的实现：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">struct</span> ConnectAndProcess <span class="token punctuation">{</span>
    connect<span class="token punctuation">:</span> ConnectFuture<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> Future <span class="token keyword">for</span> ConnectAndProcess <span class="token punctuation">{</span>
    <span class="token keyword">type</span> Item <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">type</span> Error <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">fn</span> <span class="token function">poll</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> Poll<span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token punctuation">::</span>Item<span class="token punctuation">,</span> <span class="token keyword">Self</span><span class="token punctuation">::</span>Error<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> socket <span class="token operator">=</span> <span class="token function">try_ready!</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>connect<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tokio<span class="token punctuation">::</span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token function">process</span><span class="token punctuation">(</span>socket<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">Ok</span><span class="token punctuation">(</span>Async<span class="token punctuation">::</span><span class="token function">Ready</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="使用driver注册资源"><a href="#使用driver注册资源" aria-hidden="true" class="header-anchor">#</a> 使用driver注册资源</h2> <p>当使用<a href="http://docs.rs/tokio/0.1.8/tokio/net/struct.TcpListener.html#method.poll_accept" target="_blank" rel="noopener noreferrer"><code>TcpListener :: poll_accept</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>（或任何<code>poll_ *</code>函数）时，如果资源已准备好立即返回，那么它将会这样做。在这种情况下<a href="http://docs.rs/tokio/0.1.8/tokio/net/struct.TcpListener.html#method.poll_accept" target="_blank" rel="noopener noreferrer"><code>poll_accept</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，准备就绪意味着有一个套接字在队列中等待被接受。如果资源<strong>没有</strong>准备就绪，即没有待接受的套接字，然后资源要求driver一旦准备好就通知当前任务。</p> <p>第一次<code>NotReady</code>由资源返回，如果资源没有明确地使用<a href="https://docs.rs/tokio-reactor/0.1/tokio_reactor/struct.Handle.html" target="_blank" rel="noopener noreferrer"><code>Handle</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>参数分配一个driver，则资源将使用driver实例注册自身。这是通过查看与当前执行上下文关联的网络driver来完成的。</p> <p>执行上下文的默认driver使用本地线程存储，使用<a href="https://docs.rs/tokio-reactor/0.1.5/tokio_reactor/fn.with_default.html" target="_blank" rel="noopener noreferrer"><code>with_default</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>设置，并使用[<code>Handle :: current</code>]访问。运行时负责确保，从闭包内传递到<a href="https://docs.rs/tokio-reactor/0.1.5/tokio_reactor/fn.with_default.html" target="_blank" rel="noopener noreferrer"><code>with_default</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>过程轮询任务。调用[<code>Handle :: current</code>]访问本地线程由<a href="https://docs.rs/tokio-reactor/0.1.5/tokio_reactor/fn.with_default.html" target="_blank" rel="noopener noreferrer"><code>with_default</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>设置，以便将句柄返回给当前执行上下文的driver。</p> <h2 id="handle-current-vshandle-default"><a href="#handle-current-vshandle-default" aria-hidden="true" class="header-anchor">#</a> <code>Handle :: current</code> vs<code>Handle :: default</code></h2> <p><code>Handle :: current</code>和<code>Handle :: default</code>都返回一个<code>Handle</code>实例。
然而，它们略有不同。大多数情况下，<code>Handle :: default</code>就是
期望的行为。</p> <p><code>Handle :: current</code>为当前driver <strong>立即</strong>读取存储在driver中的线程局部变量。这意味着<code>Handle :: current</code>必须从设置默认driver的执行上下文中调用。 <code>Handle :: current</code>当句柄将被发送到不同的执行上下文使用并且用户希望使用特定的反应器（reactor）时使用（参见下面的示例）。</p> <p>另一方面，[<code>Handle :: default</code>]懒惰地读取线程局部变量。这允许从执行上下文之外获取<code>Handle</code>实例。使用资源时，句柄将访问线程局部变量，如上一节中所述。</p> <p>例如：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> addr<span class="token punctuation">:</span> SocketAddr <span class="token operator">=</span> <span class="token string">&quot;127.0.0.1:0&quot;</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> std_listener <span class="token operator">=</span> <span class="token punctuation">::</span>std<span class="token punctuation">::</span>net<span class="token punctuation">::</span>TcpListener<span class="token punctuation">::</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>addr<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> listener <span class="token operator">=</span> TcpListener<span class="token punctuation">::</span><span class="token function">from_std</span><span class="token punctuation">(</span>std_listener<span class="token punctuation">,</span> <span class="token operator">&amp;</span>Handle<span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    tokio<span class="token punctuation">::</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        listener<span class="token punctuation">.</span><span class="token function">incoming</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">for_each</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>socket<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
            tokio<span class="token punctuation">::</span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token function">process</span><span class="token punctuation">(</span>socket<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">map_err</span><span class="token punctuation">(</span><span class="token operator">|</span>_<span class="token operator">|</span> <span class="token function">panic!</span><span class="token punctuation">(</span><span class="token string">&quot;error&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在这个例子中，<code>incoming（）</code>返回通过调用 <code>poll_accept</code>实现的一个 <code>future</code>。  该<code>future</code>产生于具有网络driver配置作为执行上下文的一部分的运行之上。 当在执行上下文中调用<code>poll_accept</code>时，即当读取线程本地driver与<code>TcpListener</code>实例相关联。</p> <p>但是，如果直接使用<code>tokio-threadpool</code>，那么产生threadpool <code>executor</code>之上的任务就会将无法访问reactor：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> pool <span class="token operator">=</span> ThreadPool<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> listener <span class="token operator">=</span> TcpListener<span class="token punctuation">::</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>addr<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

pool<span class="token punctuation">.</span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    listener<span class="token punctuation">.</span><span class="token function">incoming</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">for_each</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>socket<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token comment">// This will never get called due to the listener not being able to</span>
        <span class="token comment">// function.</span>
        <span class="token function">unreachable!</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">map_err</span><span class="token punctuation">(</span><span class="token operator">|</span>_<span class="token operator">|</span> <span class="token function">panic!</span><span class="token punctuation">(</span><span class="token string">&quot;error&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>为了使上面的示例工作，必须为线程池的执行上下文设置反应器（reactor）。有关更多信息，请参阅<a href="https://tokio.rs/docs/going-deeper/building-runtime/" target="_blank" rel="noopener noreferrer">building a runtime<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>细节。 或者，可以使用<code>[Handle :: current]</code>获得的<code>Handle</code>：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> pool <span class="token operator">=</span> ThreadPool<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// This does not run on the pool.</span>
tokio<span class="token punctuation">::</span><span class="token function">run</span><span class="token punctuation">(</span>future<span class="token punctuation">::</span><span class="token function">lazy</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token punctuation">|</span><span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
    <span class="token comment">// Get the handle</span>
    <span class="token keyword">let</span> handle <span class="token operator">=</span> Handle<span class="token punctuation">::</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> std_listener <span class="token operator">=</span> std<span class="token punctuation">::</span>net<span class="token punctuation">::</span>TcpListener<span class="token punctuation">::</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>addr<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// This eagerly links the listener with the handle for the current reactor.</span>
    <span class="token keyword">let</span> listener <span class="token operator">=</span> TcpListener<span class="token punctuation">::</span><span class="token function">from_std</span><span class="token punctuation">(</span>std_listener<span class="token punctuation">,</span> <span class="token operator">&amp;</span>handle<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    pool<span class="token punctuation">.</span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        listener<span class="token punctuation">.</span><span class="token function">incoming</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">for_each</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>socket<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
            <span class="token comment">// Do something with the socket</span>
            <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">map_err</span><span class="token punctuation">(</span><span class="token operator">|</span>_<span class="token operator">|</span> <span class="token function">panic!</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="网络driver"><a href="#网络driver" aria-hidden="true" class="header-anchor">#</a> 网络driver</h2> <p>为所有Tokio的网络类型提供动力的driver是[<code>Reactor</code>]Crate中的[<code>tokio-reactor</code>]类型。 它是使用<strong>mio</strong>实现的。 调用[<code>Reactor :: turn</code>]使用[<code>mio :: Poll :: poll</code>]获取已注册网络资源的操作系统事件。 然后它使用[task system]通知每个网络资源已注册的任务。 任务被调度为在其关联的<code>executor</code>上运行，然后任务将网络资源视为就绪并且调用<code>poll_ *</code>函数返回<code>Async :: Ready</code>。</p> <h2 id="将driver与资源链接"><a href="#将driver与资源链接" aria-hidden="true" class="header-anchor">#</a> 将driver与资源链接</h2> <p>driver必须跟踪向其注册的每个资源。 虽然实际实现更复杂，但可以将其视为对单元共享状态的共享引用，类似于：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">struct</span> Registration <span class="token punctuation">{</span>
    <span class="token comment">// The registration needs to know its ID. This allows it to remove state</span>
    <span class="token comment">// from the reactor when it is dropped.</span>
    id<span class="token punctuation">:</span> Id<span class="token punctuation">,</span>

    <span class="token comment">// The task that owns the resource and is registered to receive readiness</span>
    <span class="token comment">// notifications from the driver.</span>
    <span class="token comment">//</span>
    <span class="token comment">// If `task` is `Some`, we **definitely** know that the resource</span>
    <span class="token comment">// is not ready because we have not yet received an operating system event.</span>
    <span class="token comment">// This allows avoiding syscalls that will return `NotReady`.</span>
    <span class="token comment">//</span>
    <span class="token comment">// If `task` is `None`, then the resource **might** be ready. We can try the</span>
    <span class="token comment">// syscall, but it might still return `NotReady`.</span>
    task<span class="token punctuation">:</span> Option<span class="token operator">&lt;</span>task<span class="token punctuation">::</span>Task<span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">struct</span> TcpListener <span class="token punctuation">{</span>
    mio_listener<span class="token punctuation">:</span> mio<span class="token punctuation">::</span>TcpListener<span class="token punctuation">,</span>
    registration<span class="token punctuation">:</span> Option<span class="token operator">&lt;</span>Arc<span class="token operator">&lt;</span>Mutex<span class="token operator">&lt;</span>Registration<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">struct</span> Reactor <span class="token punctuation">{</span>
    poll<span class="token punctuation">:</span> mio<span class="token punctuation">::</span>Poll<span class="token punctuation">,</span>
    resources<span class="token punctuation">:</span> HashMap<span class="token operator">&lt;</span>Id<span class="token punctuation">,</span> Arc<span class="token operator">&lt;</span>Mutex<span class="token operator">&lt;</span>Registration<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>这不是真正的实现</strong>，而是用于演示行为的简化版本。在实践中，没有<code>Mutex</code>，每个资源实例没有分配单元，并且reactor不使用<code>HashMap</code>。 真正的实现在<a href="https://github.com/tokio-rs/tokio/blob/master/tokio-reactor/src/lib.rs" target="_blank" rel="noopener noreferrer">here<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>首次使用资源时，它会向driver注册：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">impl</span> TcpListener <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function">poll_accept</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> Poll<span class="token operator">&lt;</span>TcpStream<span class="token punctuation">,</span> io<span class="token punctuation">::</span>Error<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// If the registration is not set, this will associate the `TcpListener`</span>
        <span class="token comment">// with the current execution context's reactor.</span>
        <span class="token keyword">let</span> registration <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>registration<span class="token punctuation">.</span><span class="token function">get_or_insert_with</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span><span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
            <span class="token comment">// Access the thread-local variable that tracks the reactor.</span>
            Reactor<span class="token punctuation">::</span><span class="token function">with_current</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>reactor<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
                <span class="token comment">// Registers the listener, which implements `mio::Evented`.</span>
                <span class="token comment">// `register` returns the registration instance for the resource.</span>
                reactor<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>mio_listener<span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> registration<span class="token punctuation">.</span>task<span class="token punctuation">.</span><span class="token function">is_none</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// The task is `None`, this means the resource **might** be ready.</span>
            <span class="token keyword">match</span> <span class="token keyword">self</span><span class="token punctuation">.</span>mio_listener<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">Ok</span><span class="token punctuation">(</span>socket<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    <span class="token keyword">let</span> socket <span class="token operator">=</span> <span class="token function">mio_socket_to_tokio</span><span class="token punctuation">(</span>socket<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token function">Ok</span><span class="token punctuation">(</span>Async<span class="token punctuation">::</span><span class="token function">Ready</span><span class="token punctuation">(</span>socket<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token function">Err</span><span class="token punctuation">(</span><span class="token keyword">ref</span> e<span class="token punctuation">)</span> <span class="token keyword">if</span> e<span class="token punctuation">.</span><span class="token function">kind</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> WouldBlock <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    <span class="token comment">// The resource is not ready, fall through to task registration</span>
                <span class="token punctuation">}</span>
                <span class="token function">Err</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    <span class="token comment">// All other errors are returned to the caller</span>
                    <span class="token keyword">return</span> <span class="token function">Err</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// The task is set even if it is already `Some`, this handles the case where</span>
        <span class="token comment">// the resource is moved to a different task than the one stored in</span>
        <span class="token comment">// `self.task`.</span>
        registration<span class="token punctuation">.</span>task <span class="token operator">=</span> <span class="token function">Some</span><span class="token punctuation">(</span>task<span class="token punctuation">::</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">Ok</span><span class="token punctuation">(</span>Async<span class="token punctuation">::</span>NotReady<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>请注意，每个资源只有一个<code>task</code>字段。其含义是资源一次只能从一个任务中使用。如果<code>TcpListener :: poll_accept</code>返回<code>NotReady</code>，注册当前任务和将监听器发送到另一个调用<code>poll_accept</code>的任务并视为<code>NotReady</code>，然后第二个任务是唯一一个在套接字准备好被接受后将接收通知的任务。资源可能会支持跟踪不同操作的不同任务。例如，<code>TcpStream</code>内部有两个任务字段：一个用于通知<code>read</code>准备好了，另一个用于通知<code>write</code>准备好了。这允许从不同的任务调用<code>TcpStream :: poll_read</code>和<code>TcpStream :: poll_write</code>。</p> <p>[<code>mio :: Poll</code>]作为<code>register</code>上面使用的函数的一部分，将事件类型注册到驱动程序的实例中。。同样，本指南使用了<strong>简化的</strong>实现与实际<code>tokio-reactor</code>的实现不匹配,但足以理解<code>tokio-reactor</code>的行为方式。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">impl</span> Reactor <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> register<span class="token operator">&lt;</span>T<span class="token punctuation">:</span> mio<span class="token punctuation">::</span>Evented<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> evented<span class="token punctuation">:</span> <span class="token operator">&amp;</span>T<span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> Arc<span class="token operator">&lt;</span>Mutex<span class="token operator">&lt;</span>Registration<span class="token operator">&gt;&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// Generate a unique identifier for this registration. This identifier</span>
        <span class="token comment">// can be converted to and from a Mio Token.</span>
        <span class="token keyword">let</span> id <span class="token operator">=</span> <span class="token function">generate_unique_identifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Register the I/O type with Mio</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>poll<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>
            evented<span class="token punctuation">,</span> id<span class="token punctuation">.</span><span class="token function">into_token</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            mio<span class="token punctuation">::</span>Ready<span class="token punctuation">::</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            mio<span class="token punctuation">::</span>PollOpt<span class="token punctuation">::</span><span class="token function">edge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> registration <span class="token operator">=</span> Arc<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>Mutex<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>Registration <span class="token punctuation">{</span>
            id<span class="token punctuation">,</span>
            task<span class="token punctuation">:</span> None<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">self</span><span class="token punctuation">.</span>resources<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> registration<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        registration
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="运行driver"><a href="#运行driver" aria-hidden="true" class="header-anchor">#</a> 运行driver</h2> <p>driver需要运行才能使其相关资源正常工作。如果driver无法运行，资源永远不会准备就绪。使用<a href="https://docs.rs/tokio/0.1/tokio/runtime/struct.Runtime.html" target="_blank" rel="noopener noreferrer"><code>Runtime</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>时会自动处理运行driver，但了解它是如何工作的很有用。如果你对真正的实现感兴趣，那么[<code>tokio-reactor</code>] <a href="https://github.com/tokio-rs/tokio/blob/master/tokio-reactor/src/lib.rs" target="_blank" rel="noopener noreferrer">real-impl<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>源码是最好的参考。</p> <p>当资源注册到driver时，它们也会注册Mio，运行driver在循环中执行以下步骤：</p> <p>1)调用[<code>Poll :: poll</code>]来获取操作系统事件。</p> <p>2)发送所有事件到适当的注册过的资源。</p> <p>上面的步骤是通过调用<code>Reactor :: turn</code>来完成的。循环部分是取决于我们。这通常在后台线程中完成或嵌入<code>executor</code>中作为一个<a href="https://docs.rs/tokio-executor/0.1/tokio_executor/park/trait.Park.html" target="_blank" rel="noopener noreferrer"><code>Park</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>实现。有关详细信息，请参阅<a href="https://tokio-zh.github.io/document/building-runtime.html" target="_blank" rel="noopener noreferrer">runtime guide<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">loop</span> <span class="token punctuation">{</span>
    <span class="token comment">// `None` means never timeout, blocking until we receive an operating system</span>
    <span class="token comment">// event.</span>
    reactor<span class="token punctuation">.</span><span class="token function">turn</span><span class="token punctuation">(</span>None<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>turn</code>的实现执行以下操作：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function">turn</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Create storage for operating system events. This shouldn't be created</span>
    <span class="token comment">// each time `turn` is called, but doing so does not impact behavior.</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> events <span class="token operator">=</span> mio<span class="token punctuation">::</span>Events<span class="token punctuation">::</span><span class="token function">with_capacity</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">self</span><span class="token punctuation">.</span>poll<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> events<span class="token punctuation">,</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> event <span class="token keyword">in</span> <span class="token operator">&amp;</span>events <span class="token punctuation">{</span>
        <span class="token keyword">let</span> id <span class="token operator">=</span> Id<span class="token punctuation">::</span><span class="token function">from_token</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">token</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token function">Some</span><span class="token punctuation">(</span>registration<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>resources<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token function">Some</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span> <span class="token operator">=</span> registration<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>task<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                task<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>任务在其executor上进行调度会通知任务会结果。 当任务再次运行，它将再次调用<code>poll_accept</code>函数。 这次，<code>task</code>插槽将是<code>None</code>。 这意味着应该尝试系统调用，并且这次<code>poll_accept</code>将返回一个被接受的套接字（可能允许虚假事件）。</p></div> <div class="page-edit"><div class="edit-link"><a href="https://github.com/tokio-zh/tokio-zh/edit/master/docs/document/internals/net.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">上次更新: </span> <span class="time">4/21/2019, 7:08:11 AM</span></div></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/document/internals/runtime-model.html" class="prev">
          运行时模型
        </a></span> <span class="next"><a href="/document/api.html">
          API文档
        </a>
        →
      </span></p></div> <div class="bsa-cpc-wrapper"><div class="bsa-cpc"></div></div></div> <!----></div></div>
    <script src="/assets/js/app.8bade797.js" defer></script><script src="/assets/js/38.6f18dc3e.js" defer></script>
  </body>
</html>
