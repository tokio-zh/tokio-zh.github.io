<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>运行时模型 | Tokio中文</title>
    <meta name="description" content="Tokio：Rust编程语言的异步运行时,提供异步事件驱动平台，构建快速，可靠和轻量级网络应用。利用Rust的所有权和并发模型确保线程安全">
    <link rel="icon" href="/favicon.ico">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#3eaf7c">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="apple-touch-icon" href="/icons/apple-touch-icon-152x152.png">
  <meta name="msapplication-TileImage" content="/icons/msapplication-icon-144x144.png">
  <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/assets/css/styles.8bade797.css" as="style"><link rel="preload" href="/assets/js/app.8bade797.js" as="script"><link rel="preload" href="/assets/js/39.1064e57f.js" as="script"><link rel="prefetch" href="/assets/css/1.styles.729a41a7.css"><link rel="prefetch" href="/assets/css/2.styles.6f2df653.css"><link rel="prefetch" href="/assets/js/1.729a41a7.js"><link rel="prefetch" href="/assets/js/10.f4dee4dc.js"><link rel="prefetch" href="/assets/js/11.0a79d276.js"><link rel="prefetch" href="/assets/js/12.9a1ecca2.js"><link rel="prefetch" href="/assets/js/13.f323aedb.js"><link rel="prefetch" href="/assets/js/14.f94ed1c8.js"><link rel="prefetch" href="/assets/js/15.2e17eed0.js"><link rel="prefetch" href="/assets/js/16.5f7f0fb0.js"><link rel="prefetch" href="/assets/js/17.a804f778.js"><link rel="prefetch" href="/assets/js/18.917a7b15.js"><link rel="prefetch" href="/assets/js/19.515a2278.js"><link rel="prefetch" href="/assets/js/2.6f2df653.js"><link rel="prefetch" href="/assets/js/20.773272da.js"><link rel="prefetch" href="/assets/js/21.40aff844.js"><link rel="prefetch" href="/assets/js/22.0786618d.js"><link rel="prefetch" href="/assets/js/23.c63536e4.js"><link rel="prefetch" href="/assets/js/24.9c06a2f7.js"><link rel="prefetch" href="/assets/js/25.4a194b57.js"><link rel="prefetch" href="/assets/js/26.40c11936.js"><link rel="prefetch" href="/assets/js/27.9e35a1f5.js"><link rel="prefetch" href="/assets/js/28.f007bc19.js"><link rel="prefetch" href="/assets/js/29.b2b6291e.js"><link rel="prefetch" href="/assets/js/3.6ae31a5f.js"><link rel="prefetch" href="/assets/js/30.f37829da.js"><link rel="prefetch" href="/assets/js/31.a71b9216.js"><link rel="prefetch" href="/assets/js/32.33337511.js"><link rel="prefetch" href="/assets/js/33.2eb4488f.js"><link rel="prefetch" href="/assets/js/34.967d43ee.js"><link rel="prefetch" href="/assets/js/35.95be69d9.js"><link rel="prefetch" href="/assets/js/36.9c0eb4ef.js"><link rel="prefetch" href="/assets/js/37.8fba8c6a.js"><link rel="prefetch" href="/assets/js/38.6f18dc3e.js"><link rel="prefetch" href="/assets/js/4.4178ba81.js"><link rel="prefetch" href="/assets/js/40.0122edd7.js"><link rel="prefetch" href="/assets/js/41.c85cb408.js"><link rel="prefetch" href="/assets/js/42.f08452f5.js"><link rel="prefetch" href="/assets/js/43.923b63dc.js"><link rel="prefetch" href="/assets/js/44.fe42b200.js"><link rel="prefetch" href="/assets/js/45.fbe2b9fb.js"><link rel="prefetch" href="/assets/js/5.9ab7d2a6.js"><link rel="prefetch" href="/assets/js/6.e89b2efe.js"><link rel="prefetch" href="/assets/js/7.2ef1920d.js"><link rel="prefetch" href="/assets/js/8.60746b2b.js"><link rel="prefetch" href="/assets/js/9.740f1fa8.js">
    <link rel="stylesheet" href="/assets/css/styles.8bade797.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Tokio中文</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/document/" class="nav-link router-link-active">文档</a></div><div class="nav-item"><a href="/community/" class="nav-link">社区</a></div><div class="nav-item"><a href="/blog/" class="nav-link">博客</a></div><div class="nav-item"><a href="https://rustlang-cn.org/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Rust中文
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://tokio.rs" target="_blank" rel="noopener noreferrer" class="nav-link external">
  英文
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/tokio-zh/tokio-zh" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/document/" class="nav-link router-link-active">文档</a></div><div class="nav-item"><a href="/community/" class="nav-link">社区</a></div><div class="nav-item"><a href="/blog/" class="nav-link">博客</a></div><div class="nav-item"><a href="https://rustlang-cn.org/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Rust中文
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://tokio.rs" target="_blank" rel="noopener noreferrer" class="nav-link external">
  英文
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/tokio-zh/tokio-zh" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav> <div class="carbon-ads"></div> <ul class="sidebar-links"><li><a href="/document/" class="sidebar-link">何为Tokio</a></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>开始</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/document/getting-started/hello-world.html" class="sidebar-link">Hello World</a></li><li><a href="/document/getting-started/futures.html" class="sidebar-link">Futures</a></li><li><a href="/document/getting-started/runtime.html" class="sidebar-link">运行时</a></li><li><a href="/document/getting-started/echo.html" class="sidebar-link">示例：Echo服务器</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>Tokio与I/O</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/document/io/overview.html" class="sidebar-link">I/O概叙</a></li><li><a href="/document/io/reading_writing_data.html" class="sidebar-link">读写数据</a></li><li><a href="/document/io/poll.html" class="sidebar-link">Poll（轮询）APIs</a></li><li><a href="/document/io/async_read_write.html" class="sidebar-link">直接使用AsyncRead和AsyncWrite</a></li><li><a href="/document/io/filesystem.html" class="sidebar-link">文件系统APIs</a></li><li><a href="/document/io/datagrams.html" class="sidebar-link">Datagram APIs</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>Futures-Streams-Sinks</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/document/futures-streams-sinks/overview.html" class="sidebar-link">概叙</a></li><li><a href="/document/futures-streams-sinks/futures.html" class="sidebar-link">使用Future</a></li><li><a href="/document/futures-streams-sinks/streams.html" class="sidebar-link">使用Stream</a></li><li><a href="/document/futures-streams-sinks/sink.html" class="sidebar-link">使用Sink</a></li><li><a href="/document/futures-streams-sinks/putting-it-together.html" class="sidebar-link">结合在一起</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>深入</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/document/going-deeper/futures.html" class="sidebar-link">Futures</a></li><li><a href="/document/going-deeper/tasks.html" class="sidebar-link">任务</a></li><li><a href="/document/going-deeper/runtime-model.html" class="sidebar-link">运行时模型</a></li><li><a href="/document/going-deeper/io.html" class="sidebar-link">Tokio与I/O</a></li><li><a href="/document/going-deeper/chat.html" class="sidebar-link">示例：聊天服务器</a></li><li><a href="/document/going-deeper/timers.html" class="sidebar-link">Timers</a></li><li><a href="/document/going-deeper/futures-mechanics.html" class="sidebar-link">基础组合器</a></li><li><a href="/document/going-deeper/returning.html" class="sidebar-link">返回Futures</a></li><li><a href="/document/going-deeper/frames.html" class="sidebar-link">使用构建流</a></li><li><a href="/document/going-deeper/building-runtime.html" class="sidebar-link">构建一个运行时</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading open"><span>内部原理</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/document/internals/intro.html" class="sidebar-link">介绍</a></li><li><a href="/document/internals/runtime-model.html" class="active sidebar-link">运行时模型</a></li><li><a href="/document/internals/net.html" class="sidebar-link">非阻塞I/O</a></li></ul></div></li><li><a href="/document/api.html" class="sidebar-link">API文档</a></li></ul> </div> <div class="page"> <div class="content"><h1 id="运行时模型"><a href="#运行时模型" aria-hidden="true" class="header-anchor">#</a> 运行时模型</h1> <p>使用Tokio编写的应用程序组织在大量小的非阻塞任务中。 Tokio任务类似于<a href="https://www.golang-book.com/books/intro/10#section1" target="_blank" rel="noopener noreferrer">goroutine<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>或者<a href="http://erlang.org/doc/reference_manual/processes.html" target="_blank" rel="noopener noreferrer">Erlang进程<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，但是是非阻塞的。它们设计为轻量级，可以快速生成，并保持较低的调度开销。它们也是非阻塞的，因为无法立即完成的此类操作必须立即返回。它们返回一个表示操作正在进行的值，而不是返回操作的结果,表明操作正在进行中。</p> <h2 id="非阻塞执行"><a href="#非阻塞执行" aria-hidden="true" class="header-anchor">#</a> 非阻塞执行</h2> <p>使用<a href="https://docs.rs/futures/0.1/futures/future/trait.Future.html" target="_blank" rel="noopener noreferrer">Future<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> trait实现Tokio任务：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">struct</span> MyTask <span class="token punctuation">{</span>
    my_resource<span class="token punctuation">:</span> MyResource<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> Future <span class="token keyword">for</span> MyTask <span class="token punctuation">{</span>
    <span class="token keyword">type</span> Item <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">type</span> Error <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">fn</span> <span class="token function">poll</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> Poll<span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token punctuation">::</span>Item<span class="token punctuation">,</span> <span class="token keyword">Self</span><span class="token punctuation">::</span>Error<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">match</span> <span class="token keyword">self</span><span class="token punctuation">.</span>my_resource<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">Ok</span><span class="token punctuation">(</span>Async<span class="token punctuation">::</span><span class="token function">Ready</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">Ok</span><span class="token punctuation">(</span>Async<span class="token punctuation">::</span><span class="token function">Ready</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token function">Ok</span><span class="token punctuation">(</span>Async<span class="token punctuation">::</span>NotReady<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">Ok</span><span class="token punctuation">(</span>Async<span class="token punctuation">::</span>NotReady<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function">Err</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">process_err</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">Ok</span><span class="token punctuation">(</span>Async<span class="token punctuation">::</span><span class="token function">Ready</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>使用<code>tokio :: spawn</code>或通过调用<code>executor</code>对象上的<a href="https://docs.rs/futures/0.1/futures/executor/struct.Spawn.html" target="_blank" rel="noopener noreferrer">Spawn<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>方法将任务提交给 <code>executor</code>。 <code>poll</code>函数驱动任务。没有调用<code>poll</code>就什么都不做。在任务上调用<code>poll</code>直到<code>Ready（（））</code>返回是 <code>executor</code>的工作。</p> <p><code>MyTask</code>将从<code>my_resource</code>接收一个值并处理它。一旦值处理完毕，任务就完成了他的逻辑并结束。这会返回<code>Ok（Async :: Ready（（）））</code>。</p> <p>为了完成处理，任务取决于<code>my_resource</code>提供的值。鉴于<code>my_resource</code>是一个非阻塞任务，它在调用<code>my_resource.poll（）</code>时，可能准备好或者还没准备好提供值。如果它准备就绪，它返回<code>Ok（Async :: Ready（value））</code>。如果没有准备好，它会返回<code>Ok(Async::NotReady)</code>。</p> <p>当资源未准备好提供值时，这意味着该任务本身还没准备好完成，任务的<code>poll</code>函数也返回<code>NotReady</code>。</p> <p>在未来的某个时刻，资源将随时准备提供值。资源使用任务系统向 <code>executor</code>发信号给<code>executor</code>通知它已准备好。 <code>executor</code>安排任务，导致<code>MyTask :: poll</code>又叫了一遍。这一次，假设<code>my_resource</code>准备就绪，那么值就是从<code>my_resource.poll（）</code>返回并且任务完成。</p> <h2 id="协作调度"><a href="#协作调度" aria-hidden="true" class="header-anchor">#</a> 协作调度</h2> <p>协作调度用于在 <code>executor</code>上调度任务。单个 <code>executor</code>将通过一小组线程管理许多任务。将有比线程更多的任务。这也没有抢占。这个意味着当任务被安排执行时，它会阻止当前线程直到<code>poll</code>函数返回。</p> <p>因此，实现<code>poll</code>在很短的时间内执行才是重要的。对于I / O绑定的应用程序，通常会发生这种情况。但是，如果任务预计必须长时间运行，则应该推迟工作到<a href="https://docs.rs/tokio-threadpool/0.1/tokio_threadpool/fn.blocking.html" target="_blank" rel="noopener noreferrer">blocking pool<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>或将计算分解为更小的块和在每个块执行之后<a href="https://tokio.rs/docs/internals/runtime-model/#yielding" target="_blank" rel="noopener noreferrer">yield<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>回来。</p> <h2 id="任务系统"><a href="#任务系统" aria-hidden="true" class="header-anchor">#</a> 任务系统</h2> <p>任务系统是资源通知<code>executor</code>准备就绪的系统。 任务由消耗资源的非阻塞逻辑组成。 在上面的示例中，<code>MyTask</code>使用单个资源<code>my_resource</code>，但没有限制任务可以使用的资源数量。</p> <p>当任务正在执行并尝试使用未准备好的资源时，它在该资源上被<em>逻辑</em>阻塞，即任务无法进一步处理，直到资源准备就绪。 Tokio跟踪阻塞当前任务的资源以进行推进。当一个依赖资源准备就绪， <code>executor</code>安排任务。这是通过跟踪<strong>当任务在资源中表现兴趣</strong>完成。</p> <p>当<code>MyTask</code>执行，尝试使用<code>my_resource</code>和<code>my_resource</code>返回<code>NotReady</code>时，<code>MyTask</code>隐含表示对<code>my_resource</code>资源感兴趣。对此，任务和资源是连接的。什么时候资源准备就绪，任务再次被安排。</p> <h2 id="task-current和task-notify"><a href="#task-current和task-notify" aria-hidden="true" class="header-anchor">#</a> <code>task :: current</code>和<code>Task :: notify</code></h2> <p>通过两个API完成跟踪兴趣并通知准备情况的变化：</p> <ul><li><a href="https://docs.rs/futures/0.1/futures/task/fn.current.html" target="_blank" rel="noopener noreferrer"><code>task::current</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://docs.rs/futures/0.1/futures/task/struct.Task.html#method.notify" target="_blank" rel="noopener noreferrer"><code>Task::notify</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <p>当调用<code>my_resource.poll（）</code>时，如果资源准备就绪，则立即返回值而不使用任务系统。如果资源<strong>没有</strong>准备好，通过调用<a href="https://docs.rs/futures/0.1/futures/task/fn.current.html" target="_blank" rel="noopener noreferrer"><code>task::current() -&gt; Task</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 来获取当前任务的句柄。这是通过读取<code>executor</code>设置的线程局部变量集获得此句柄。</p> <p>一些外部事件（在网络上接收的数据，后台线程完成计算等...)将导致<code>my_resource</code>准备好生成它的值。那时，准备好<code>my_resource</code>的逻辑将调用从<a href="https://docs.rs/futures/0.1/futures/task/fn.current.html" target="_blank" rel="noopener noreferrer"><code>task :: current</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>获得的任务句柄上的<a href="https://docs.rs/futures/0.1/futures/executor/trait.Notify.html" target="_blank" rel="noopener noreferrer"><code>notify</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。这个表示准备就绪会改变 <code>executor</code>， <code>executor</code>随后安排任务执行。</p> <p>如果多个任务表示对资源感兴趣，则只有<strong>last</strong>任务这样做会得到通知。资源旨在从单一任务使用。</p> <h2 id="async-notready"><a href="#async-notready" aria-hidden="true" class="header-anchor">#</a> <code>Async :: NotReady</code></h2> <p>任何返回<code>Async</code>的函数都必须遵守<a href="https://docs.rs/futures/0.1.23/futures/future/trait.Future.html#tymethod.poll" target="_blank" rel="noopener noreferrer">contract<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>(契约)。 当返回<code>NotReady</code>，当前任务<strong>必须</strong>已经注册准备就绪的变更通知。 以上部分讨论了资源的含义。 对于任务逻辑，这意味着无法返回<code>NotReady</code>除非资源已返回“NotReady”。 通过这样做，<a href="https://docs.rs/futures/0.1.23/futures/future/trait.Future.html#tymethod.poll" target="_blank" rel="noopener noreferrer">contract<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>得到了传承。 当前任务已注册通知，因为已从资源收到<code>NotReady</code>。</p> <p>必须非常小心避免在没有从资源收到<code>NotReady</code>的情况下返回<code>NotReady</code>。 例如，以下任务中，任务实现结果永远不会完成。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> futures<span class="token punctuation">::</span><span class="token punctuation">{</span>Future<span class="token punctuation">,</span> Poll<span class="token punctuation">,</span> Async<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">enum</span> BadTask <span class="token punctuation">{</span>
    <span class="token function">First</span><span class="token punctuation">(</span>Resource1<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">Second</span><span class="token punctuation">(</span>Resource2<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> Future <span class="token keyword">for</span> BadTask <span class="token punctuation">{</span>
    <span class="token keyword">type</span> Item <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">type</span> Error <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">fn</span> <span class="token function">poll</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> Poll<span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token punctuation">::</span>Item<span class="token punctuation">,</span> <span class="token keyword">Self</span><span class="token punctuation">::</span>Error<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">use</span> BadTask<span class="token punctuation">::</span><span class="token operator">*</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> value <span class="token operator">=</span> <span class="token keyword">match</span> <span class="token operator">*</span><span class="token keyword">self</span> <span class="token punctuation">{</span>
            <span class="token function">First</span><span class="token punctuation">(</span><span class="token keyword">ref</span> <span class="token keyword">mut</span> resource<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token function">try_ready!</span><span class="token punctuation">(</span>resource<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token function">Second</span><span class="token punctuation">(</span><span class="token keyword">ref</span> <span class="token keyword">mut</span> resource<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token function">try_ready!</span><span class="token punctuation">(</span>resource<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token function">Ok</span><span class="token punctuation">(</span>Async<span class="token punctuation">::</span><span class="token function">Ready</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token operator">*</span><span class="token keyword">self</span> <span class="token operator">=</span> <span class="token function">Second</span><span class="token punctuation">(</span>Resource2<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">Ok</span><span class="token punctuation">(</span>Async<span class="token punctuation">::</span>NotReady<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>上面实现的问题是<code>Ok（Async :: NotReady）</code>是在将状态转换为<code>Second</code>后立即返回。 在这转换中，没有资源返回<code>NotReady</code>。 当任务本身返回时<code>NotReady</code>，它违反了<a href="https://docs.rs/futures/0.1.23/futures/future/trait.Future.html#tymethod.poll" target="_blank" rel="noopener noreferrer">contract<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> ，因为任务将来不会被通知。</p> <p>通常通过添加循环来解决这种情况：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> futures<span class="token punctuation">::</span><span class="token punctuation">{</span>Future<span class="token punctuation">,</span> Poll<span class="token punctuation">,</span> Async<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function">poll</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> Poll<span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token punctuation">::</span>Item<span class="token punctuation">,</span> <span class="token keyword">Self</span><span class="token punctuation">::</span>Error<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">use</span> BadTask<span class="token punctuation">::</span><span class="token operator">*</span><span class="token punctuation">;</span>
    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> value <span class="token operator">=</span> <span class="token keyword">match</span> <span class="token operator">*</span><span class="token keyword">self</span> <span class="token punctuation">{</span>
            <span class="token function">First</span><span class="token punctuation">(</span><span class="token keyword">ref</span> <span class="token keyword">mut</span> resource<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token function">try_ready!</span><span class="token punctuation">(</span>resource<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token function">Second</span><span class="token punctuation">(</span><span class="token keyword">ref</span> <span class="token keyword">mut</span> resource<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token function">try_ready!</span><span class="token punctuation">(</span>resource<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token function">Ok</span><span class="token punctuation">(</span>Async<span class="token punctuation">::</span><span class="token function">Ready</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token operator">*</span><span class="token keyword">self</span> <span class="token operator">=</span> <span class="token function">Second</span><span class="token punctuation">(</span>Resource2<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>思考它的一种方法是任务的<code>poll</code>函数<strong>不能</strong>返回，直到由于其资源不能进一步取得进展而准备就绪或明确<code>yields</code>（见下文）。</p> <p>另请注意，返回<code>Async</code>的<strong>函数只能从一个任务调用</strong>。 换句话说，这些函数只能从已经提交给<code>tokio :: spawn</code>或其他任务spawn函数调用</p> <h2 id="yielding"><a href="#yielding" aria-hidden="true" class="header-anchor">#</a> Yielding</h2> <p>有时，任务必须返回<code>NotReady</code>而不是在资源上被阻塞。这通常发生在运行计算很大且任务想要的时候将控制权交还 <code>executor</code>以允许其执行其他 <code>future</code>。</p> <p>Yielding 是通过通知当前任务并返回“NotReady”完成：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> futures<span class="token punctuation">::</span>task<span class="token punctuation">;</span>
<span class="token keyword">use</span> futures<span class="token punctuation">::</span>Async<span class="token punctuation">;</span>

<span class="token comment">// Yield the current task. The executor will poll this task next</span>
<span class="token comment">// iteration through its run list.</span>
task<span class="token punctuation">::</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token function">Ok</span><span class="token punctuation">(</span>Async<span class="token punctuation">::</span>NotReady<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Yield可用于分解CPU昂贵的计算：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">struct</span> Count <span class="token punctuation">{</span>
    remaining<span class="token punctuation">:</span> usize<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> Future <span class="token keyword">for</span> Count <span class="token punctuation">{</span>
    <span class="token keyword">type</span> Item <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">type</span> Error <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">fn</span> <span class="token function">poll</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> Poll<span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token punctuation">::</span>Item<span class="token punctuation">,</span> <span class="token keyword">Self</span><span class="token punctuation">::</span>Error<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token keyword">self</span><span class="token punctuation">.</span>remaining <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>remaining <span class="token operator">-=</span> <span class="token number">1</span><span class="token punctuation">;</span>

            <span class="token comment">// Yield every 10 iterations</span>
            <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>remaining <span class="token operator">%</span> <span class="token number">10</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
                task<span class="token punctuation">::</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token function">Ok</span><span class="token punctuation">(</span>Async<span class="token punctuation">::</span>NotReady<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token function">Ok</span><span class="token punctuation">(</span>Async<span class="token punctuation">::</span><span class="token function">Ready</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="executor"><a href="#executor" aria-hidden="true" class="header-anchor">#</a> <code>executor</code></h2> <p><code>executor</code>员负责驱动完成许多任务。任务是产生于 <code>executor</code>之上， 是在<code>executor</code>需要调用它的<code>poll</code>函数的时候。 <code>executor</code>挂钩到任务系统以接收资源准备通知。</p> <p>通过将任务系统与 <code>executor</code>实现分离，具体执行和调度逻辑可以留给 <code>executor</code>实现。<code>tokio</code>提供两个<code>executor</code>实现，每个实现具有独特的特点：<a href="http://docs.rs/tokio-current-thread" target="_blank" rel="noopener noreferrer"><code>current_thread</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>和<a href="https://docs.rs/tokio-threadpool" target="_blank" rel="noopener noreferrer"><code>thread_pool</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <p>当任务首次在<code>executor</code>之上生成时， <code>executor</code>用<a href="https://docs.rs/futures/0.1/futures/executor/struct.Spawn.html" target="_blank" rel="noopener noreferrer"><code>Spawn</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>将其包装。这将任务逻辑与任务状态绑定（这主要是遗留原因所需要的）。 <code>executor</code>通常会将任务存储在堆，通常是将它存储在<code>Box</code>或<code>Arc</code>中。当 <code>executor</code>选择一个执行任务，它调用<a href="https://docs.rs/futures/0.1/futures/executor/struct.Spawn.html#method.poll_future_notify" target="_blank" rel="noopener noreferrer"><code>Spawn :: poll_future_notify</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。此函数确保将任务上下文设置为线程局部变量像<a href="https://docs.rs/futures/0.1/futures/task/fn.current.html" target="_blank" rel="noopener noreferrer"><code>task :: current</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>能够读取它。</p> <p>当调用<a href="https://docs.rs/futures/0.1/futures/executor/struct.Spawn.html#method.poll_future_notify" target="_blank" rel="noopener noreferrer"><code>poll_future_notify</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>时， <code>executor</code>也是传递通知句柄和标识符。这些参数包含在由<a href="https://docs.rs/futures/0.1/futures/task/fn.current.html" target="_blank" rel="noopener noreferrer"><code>task :: current</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>返回的任务句柄中，也是有关任务与<code>executor</code>连接的方式。</p> <p>notify句柄是<a href="https://docs.rs/futures/0.1/futures/executor/trait.Notify.html" target="_blank" rel="noopener noreferrer"><code>Notify</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 的实现，标识符是 <code>executor</code>用于查找当前任务的值。当调用<a href="https://docs.rs/futures/0.1/futures/task/struct.Task.html#method.notify" target="_blank" rel="noopener noreferrer"><code>Task::notify</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，<a href="https://docs.rs/futures/0.1/futures/executor/trait.Notify.html#tymethod.notify" target="_blank" rel="noopener noreferrer"><code>notify</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>函数使用提供的标识符调用notify句柄。该函数的实现负责执行调度逻辑。</p> <p>实现 <code>executor</code>的一种策略是将每个任务存储在<code>Box</code>和使用链接列表来跟踪计划执行的任务。当调用<a href="https://docs.rs/futures/0.1/futures/executor/trait.Notify.html#tymethod.notify" target="_blank" rel="noopener noreferrer"><code>Notify :: notify</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，然后将与之关联的任务标识符被推送到<code>scheduled</code>链表的末尾。当 <code>executor</code>运行时，它从链表的前端弹出并执行任务如上所述。</p> <p>请注意，本节未介绍 <code>executor</code>的运行方式。细节这留给 <code>executor</code>实现。一个选项是 <code>executor</code>产生一个或多个线程并将这些线程专用于排出<code>scheduled</code>链表。另一个是提供一个<code>MyExecutor :: run</code>函数阻塞当前线程并排出<code>scheduled</code>链表。</p> <h2 id="资源，drivers和运行时"><a href="#资源，drivers和运行时" aria-hidden="true" class="header-anchor">#</a> 资源，drivers和运行时</h2> <p>资源是叶子<code>futures</code>，即未以其他<code>futures</code>实施的<code>futures</code>。它们是使用上述任务系统的类型与 <code>executor</code>互动。资源类型包括TCP和UDP套接字，定时器，通道，文件句柄等.Tokio应用程序很少需要实现资源。相反，他们使用Tokio或第三方包装箱提供的资源。</p> <p>通常，资源本身不能起作用而是需要drivers。例如，Tokio TCP套接字由<a href="https://docs.rs/tokio-reactor/0.1.5/tokio_reactor/" target="_blank" rel="noopener noreferrer"><code>Reactor</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>支持。<code>Reactor</code>是socket资源driver。单个driver可以为大量资源实例提供动力。要使用该资源，drivers必须在某处运行这个过程。 Tokio提供网络资源的drivers（<a href="https://docs.rs/tokio-reactor" target="_blank" rel="noopener noreferrer"><code>tokio-reactor</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>），文件资源（<a href="https://docs.rs/tokio-fs" target="_blank" rel="noopener noreferrer"><code>tokio-fs</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>）和定时器（<a href="https://docs.rs/tokio-timer" target="_blank" rel="noopener noreferrer"><code>tokio-timer</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>）。提供解耦driver组件允许用户选择他们想要使用的组件。每个driver可以单独使用或与其他driver结合使用。</p> <p>正因为如此，为了使用Tokio并成功执行任务，一个应用程序必须启动 <code>executor</code>和必要的drivers作为应用程序的任务依赖的资源。这需要大量的样板。为了管理样板，Tokio提供了几个运行时选项。运行时是与所有必需drivers捆绑在一起的<code>executor</code>，以便为Tokio的资源提供动力。不是单独管理所有各种Tokio组件，而是在一次调用中创建并启动运行时。</p> <p>Tokio提供<a href="https://docs.rs/tokio/0.1.8/tokio/runtime/index.html" target="_blank" rel="noopener noreferrer">并发运行时<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>和<a href="https://docs.rs/tokio/0.1.8/tokio/runtime/current_thread/index.html" target="_blank" rel="noopener noreferrer">单线程<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>运行时。并发运行时基于多线程、工作窃取 <code>executor</code>。单线程运行时执行当前线程上的所有任务和drivers。用户可以选择最适合应用的运行时。</p> <h2 id="future"><a href="#future" aria-hidden="true" class="header-anchor">#</a> Future</h2> <p>如上所述，任务是使用<a href="https://docs.rs/futures/0.1/futures/future/trait.Future.html" target="_blank" rel="noopener noreferrer">Future<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> <code>trait</code>实现的。 这个特点不仅限于实施任务。 一个 <a href="https://docs.rs/futures/0.1/futures/future/trait.Future.html" target="_blank" rel="noopener noreferrer">Future<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>是表示一个非阻塞计算的值在未来的某个时间完成。 任务是一个计算没有输出。 Tokio中的许多资源都用<a href="https://docs.rs/futures/0.1/futures/future/trait.Future.html" target="_blank" rel="noopener noreferrer">Future<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>实现。 例如，超时是<a href="https://docs.rs/futures/0.1/futures/future/trait.Future.html" target="_blank" rel="noopener noreferrer">Future<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>在达到截止日期后完成。</p> <p>该 <code>trait</code>包括许多与Future值一起工作的有用的组合器。</p> <p>通过对应用特定类型实现<code>Future</code>来构建应用或使用组合器来定义应用程序逻辑。 通常两者兼而有之策略是最成功的。</p></div> <div class="page-edit"><div class="edit-link"><a href="https://github.com/tokio-zh/tokio-zh/edit/master/docs/document/internals/runtime-model.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">上次更新: </span> <span class="time">11/4/2018, 4:39:08 AM</span></div></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/document/internals/intro.html" class="prev">
          介绍
        </a></span> <span class="next"><a href="/document/internals/net.html">
          非阻塞I/O
        </a>
        →
      </span></p></div> <div class="bsa-cpc-wrapper"><div class="bsa-cpc"></div></div></div> <!----></div></div>
    <script src="/assets/js/app.8bade797.js" defer></script><script src="/assets/js/39.1064e57f.js" defer></script>
  </body>
</html>
